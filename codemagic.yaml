
workflows:
  android-build:
    name: Android Release Build (AAB)
    environment:
      node: 20
      java: 21
      groups:
        - supabase_keys
        - signing
    scripts:
      - name: Install dependencies
        script: npm install
      - name: Create .env file
        script: |
          echo "NEXT_PUBLIC_SUPABASE_URL=$NEXT_PUBLIC_SUPABASE_URL" >> .env
          echo "NEXT_PUBLIC_SUPABASE_ANON_KEY=$NEXT_PUBLIC_SUPABASE_ANON_KEY" >> .env
      - name: Build web assets
        script: npm run build
      - name: Add or Sync Android Platform
        script: |
          # This script handles two cases:
          # 1. If the 'android' directory doesn't exist (clean build), it adds it.
          # 2. If it exists (cached build), it syncs it, preserving the previous versionCode.
          if [ ! -d "android" ]; then
            echo "Android directory not found. Adding platform from scratch."
            npx cap add android
          else
            echo "Android directory found. Syncing existing platform."
            # Failsafe: Ensure assets directory exists before syncing, in case of a corrupted cache.
            mkdir -p android/app/src/main/assets
            npx cap sync android
          fi
      - name: Update Version Code and Name
        script: |
          BUILD_GRADLE_PATH="android/app/build.gradle"
          # Use Codemagic's built-in BUILD_NUMBER for versionCode
          sed -i "s/versionCode [0-9]\+/versionCode $BUILD_NUMBER/" $BUILD_GRADLE_PATH
          # Use a fixed prefix and the BUILD_NUMBER for versionName
          sed -i "s/versionName \".*\"/versionName \"1.1.$BUILD_NUMBER\"/" $BUILD_GRADLE_PATH
          echo "Checking updated build.gradle:"
          grep "versionCode" $BUILD_GRADLE_PATH
          grep "versionName" $BUILD_GRADLE_PATH
      - name: Decode Keystore File
        script: echo $CM_KEYSTORE | base64 --decode > $CM_BUILD_DIR/keystore.jks
      - name: Make gradlew executable
        script: chmod +x android/gradlew
      - name: Build Android Release AAB
        script: |
          cd android && ./gradlew bundleRelease \
            -Pandroid.injected.signing.store.file=$CM_BUILD_DIR/keystore.jks \
            -Pandroid.injected.signing.store.password=$CM_KEYSTORE_PASSWORD \
            -Pandroid.injected.signing.key.alias=$CM_KEY_ALIAS \
            -Pandroid.injected.signing.key.password=$CM_KEY_ALIAS_PASSWORD
    artifacts:
      - android/app/build/outputs/bundle/release/*.aab

